name: Build and Publish CommandSage

on:
  push:
    branches:
      - main

jobs:
  build-and-upload:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        run: node cmdsage.js test

      - name: Extract Addon Version
        id: extract_version
        run: |
          VERSION_LINE=$(grep -m1 -oP '(?<=Version-).*(?=-blue)' README.md || echo "4.3")
          echo "addon_version=$VERSION_LINE" >> $GITHUB_OUTPUT

      - name: Update TOC Version
        run: |
          echo "Detected version: ${{ steps.extract_version.outputs.addon_version }}"
          sed -i "s/## Version: .*/## Version: ${{ steps.extract_version.outputs.addon_version }}/" CommandSage.toc

      - name: Build Addon
        run: node cmdsage.js build

      - name: Package Addon
        run: |
          mkdir -p dist
          zip -r dist/CommandSage-${{ steps.extract_version.outputs.addon_version }}.zip . \
            -x "*.git*" \
            -x ".github*" \
            -x "scripts/*" \
            -x "dist/*" \
            -x "tests/*"

      - name: Upload artifact to GitHub
        uses: actions/upload-artifact@v2
        with:
          name: CommandSage-Zip
          path: dist/CommandSage-${{ steps.extract_version.outputs.addon_version }}.zip

      - name: Publish to CurseForge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && contains(github.event.head_commit.message, '[release]')
        run: |
          echo "Publishing to CurseForge..."
          node scripts/publish-curseforge.js dist/CommandSage-${{ steps.extract_version.outputs.addon_version }}.zip ${{ secrets.CURSEFORGE_TOKEN }}

      - name: Publish to SourceForge (Example)
        if: false
        run: |
          echo "Would upload to SourceForge with credentials."
